(()=>{"use strict";class e{constructor(e,t,n){this.audioContext=e,this.masterGain=t,this.remoteAudioNodes={},this.pannerRadius=n,this.pannerGainCoef=1}addAudioNode(e,t){if(this.remoteAudioNodes[t])return;const n=document.createElement("audio");n.id="audio-"+t,n.srcObject=e,document.body.appendChild(n);const o=this.audioContext.createGain(),i=this.audioContext.createStereoPanner(),a=this.audioContext.createGain();a.gain.value=1,o.gain.value=1,n.onloadedmetadata=()=>{const e=this.audioContext.createMediaStreamSource(n.srcObject);n.play(),n.muted=!0,e.connect(o),o.connect(i),i.connect(a),a.connect(this.masterGain),this.remoteAudioNodes[t]={sourcenode:e,panninggainnode:o,pannernode:i,gainnode:a}}}removeAudioNodes(e){for(const t of e){if(!this.remoteAudioNodes[t])continue;const e=document.getElementById("audio-"+t);e.remove();const n=this.remoteAudioNodes[t].sourcenode,o=this.remoteAudioNodes[t].panninggainnode,i=this.remoteAudioNodes[t].pannernode;this.remoteAudioNodes[t].gainnode.disconnect(),i.disconnect(),o.disconnect(),n.disconnect(),e.remove(),delete this.remoteAudioNodes[t]}}adjustGain(e,t){this.remoteAudioNodes[t]&&(this.remoteAudioNodes[t].gainnode.gain.value=e)}adjustPanning(e,t,n,o,i){if(!this.remoteAudioNodes[i])return;const a=this.remoteAudioNodes[i].panninggainnode,s=this.remoteAudioNodes[i].pannernode,r=n-e,d=r>0?1:-1,m=o-t,c=Math.sqrt(r*r+m*m),l=0==r?0:d*Math.abs(Math.PI/2-Math.atan(m/r))*.3;s.pan.value=l;const h=Math.exp(-c/(this.pannerRadius*this.pannerGainCoef));a.gain.value=h}setPannerGainCoef(e){this.pannerGainCoef=e}}class t{constructor(e,t,n){this.stream=e,this.audioContext=t,this.masterGain=n,this.audioSourceNode=this.audioContext.createMediaStreamSource(e),this.gainNode=this.audioContext.createGain(),this.audioDest=this.audioContext.createMediaStreamDestination(),this.gainNode.gain.value=1,this.audioSourceNode.connect(this.gainNode),this.gainNode.connect(this.audioDest)}getFilteredStream(){return this.audioDest.stream}adjustGain(e){this.gainNode.gain.value=e}connectMictoMasterGain(){this.gainNode.connect(this.masterGain)}disconnectMicfromMasterGain(){this.gainNode.disconnect(this.masterGain)}}const n=document.getElementById("room-content-before-enter"),o=document.getElementById("room-content-after-enter"),i=1100,a=750,s=window.AudioContext||window.webkitAudioContext;let r=null,d=null,m=null,c=null,l=null,h=null,g=null;const u=document.getElementById("panner-param-canvas").getContext("2d"),p=450,v=250,I=void 0!==document.ontouchend?"touchend":"mouseup";document.addEventListener(I,(function t(){document.removeEventListener(I,t),r=new s,c=r.createGain(),l=r.createAnalyser(),h=l.frequencyBinCount,g=new Uint8Array(h),c.gain.value=1,c.connect(l),l.connect(r.destination),d=new e(r,c,400),x()}));const y=document.getElementById("panner-paramslider");function x(){requestAnimationFrame(x),u.clearRect(0,0,p,v);const e=y.value;u.lineWidth=3,u.strokeStyle="rgb(0, 0, 255)",u.beginPath(),u.moveTo(0,v-187.5*Math.exp(-1/e));for(let t=.1;t<=p;t+=.1){const n=Math.sqrt((225-t)*(225-t)),o=v-187.5*Math.exp(-n/(p*e/2));u.lineTo(t,o)}if(u.stroke(),!l)return;l.getByteTimeDomainData(g),u.lineWidth=2,u.strokeStyle="rgb(0, 0, 0)",u.beginPath();const t=p/h;let n=0;for(let e=0;e<h;e++){const o=v-g[e]/255*v;0==e?u.moveTo(n,o):u.lineTo(n,o),n+=t}u.lineTo(p,125),u.stroke()}y.oninput=()=>{const e=y.value;d.setPannerGainCoef(e)};const C=document.getElementById("master-volume");C.oninput=()=>{const e=C.value;c.gain.value=e};const f=document.getElementById("mic-input-volume");f.oninput=()=>{const e=f.value;m.adjustGain(e)};const R=document.getElementById("filter-setting"),b=document.getElementById("content-cover"),w=document.getElementById("dialog-close-btn");b.style.display="none",R.onclick=()=>{"none"===b.style.display&&(b.style.display="block",m&&m.connectMictoMasterGain())},w.onclick=()=>{"none"!==b.style.display&&(b.style.display="none",m&&m.disconnectMicfromMasterGain())};let E={};const M=new class{constructor(e,t){this.memberlistContainer=e,this.volumeSliderListener=t}createUserContent(e,t){const n=document.createElement("div");n.id=t+"-user-content",n.classList.add("room-member-content");const o=document.createElement("div"),i=document.createElement("img"),a=document.createElement("p");a.textContent=e,o.classList.add("room-member-user-info"),i.id=t+"-img",o.appendChild(i),o.appendChild(a),n.appendChild(o);const s=document.createElement("div");s.style.display="none";const r=document.createElement("span");r.classList.add("material-icons"),r.innerText="volume_up";const d=document.createElement("input");return d.dataset.peerId=t,d.type="range",d.min="0",d.max="2",d.step="0.01",d.value="1",d.addEventListener("change",this.volumeSliderListener),s.classList.add("room-member-volume-container"),s.appendChild(r),s.appendChild(d),o.onclick=()=>{"none"===s.style.display?s.style.display="flex":s.style.display="none"},n.appendChild(s),n}assignImgSrc(e,t){console.log(e),document.getElementById(e+"-img").src=t}addMembers(e){for(const t of e){const e=t.substring(0,t.length-36),n=this.createUserContent(e,t);this.memberlistContainer.appendChild(n)}}removeMembers(e){for(const t of e)document.getElementById(t+"-user-content").remove()}}(document.getElementById("room-members-container"),(e=>{const t=e.target,n=t.dataset.peerId;d.adjustGain(t.value,n)})),j=document.getElementById("target-canvas"),A=j.getContext("2d"),N=new class{constructor(e,t,n){this.targetCanvas=e,this.targetCtx=e.getContext("2d"),this.remoteImgDict={},this.avatorWidth=t,this.avatorHeight=n}addRemoteImg(e,t,n,o){if(this.remoteImgDict[e])return;const i=new Image,a=document.createElement("canvas"),s=a.getContext("2d");a.width=this.avatorWidth,a.height=this.avatorHeight,i.onload=()=>{s.lineWidth=1,s.beginPath(),s.arc(this.avatorWidth/2,this.avatorHeight/2,this.avatorWidth/2,0,2*Math.PI),s.clip(),s.drawImage(i,0,0,this.avatorWidth,this.avatorHeight),s.strokeStyle="rgb(0, 0, 0)",s.lineWidth=3,s.beginPath(),s.arc(this.avatorWidth/2,this.avatorHeight/2,this.avatorWidth/2,0,2*Math.PI),s.stroke(),this.targetCtx.drawImage(a,n,o,this.avatorWidth,this.avatorHeight)},i.src=t,this.remoteImgDict[e]={remoteimgcanvas:a,x:n,y:o}}redrawRemoteImgsAll(){for(const e in this.remoteImgDict){const{remoteimgcanvas:t,x:n,y:o}=this.remoteImgDict[e];this.targetCtx.drawImage(t,n,o,this.avatorWidth,this.avatorHeight)}}redrawRemoteImg(e,t,n){if(this.remoteImgDict[e]){this.remoteImgDict[e].x=t,this.remoteImgDict[e].y=n;for(const e in this.remoteImgDict){const{remoteimgcanvas:t,x:n,y:o}=this.remoteImgDict[e];this.targetCtx.drawImage(t,n,o,this.avatorWidth,this.avatorHeight)}}}removeRemoteImg(e){this.remoteImgDict[e].remoteimgcanvas.remove(),delete this.remoteImgDict[e];for(const e in this.remoteImgDict){const{remoteimgcanvas:t,x:n,y:o}=this.remoteImgDict[e];this.targetCtx.drawImage(t,n,o,this.avatorWidth,this.avatorHeight)}}removeRemoteImgAll(){for(const e in this.remoteImgDict)this.remoteImgDict[e].remoteimgcanvas.remove();this.remoteImgDict={}}}(j,100,100),D=new class{constructor(e,t,n,o){this.width=n,this.height=o,this.targetCanvas=e,this.targetCtx=e.getContext("2d"),this.imgSrcCanvas=document.createElement("canvas"),this.imgSrcCanvas.width=n,this.imgSrcCanvas.height=o,this.x=0,this.y=0,this.relX=null,this.relY=null,this.dragging=!1;const i=this,a=this.imgSrcCanvas.getContext("2d"),s=new Image;s.onload=function(){a.lineWidth=1,a.beginPath(),a.arc(n/2,o/2,n/2,0,2*Math.PI),a.clip(),a.drawImage(s,0,0,n,o),a.strokeStyle="rgb(0, 0, 0)",a.lineWidth=3,a.beginPath(),a.arc(n/2,o/2,n/2,0,2*Math.PI),a.stroke(),i.targetCtx.drawImage(i.imgSrcCanvas,0,0,n,o)},s.src=t}render(e,t){this.x=e,this.y=t,this.targetCtx.drawImage(this.imgSrcCanvas,e,t,this.width,this.height)}isHoldPos(e,t){return this.x<=e&&e<=this.x+this.width&&this.y<=t&&t<=this.y+this.height}}(j,selfImgUrl,100,100),P=document.getElementById("room-name-input"),B=document.getElementById("room-name-guide"),S=new class{constructor(){this.peer=null,this.joinedRoom=null}async makePeer(e,t,n){return new Promise(((o,i)=>{this.peer?o():(this.peer=new Peer(e,{key:n,credential:t}),this.peer.on("open",(e=>{o()})),this.peer.on("error",(e=>{i(e)})))}))}joinRoom(e,t,n){this.joinedRoom=this.peer.joinRoom(e,{mode:"sfu",stream:n}),this.joinedRoom.on("open",t.open),this.joinedRoom.on("peerJoin",t.peerJoin),this.joinedRoom.on("peerLeave",t.peerLeave),this.joinedRoom.on("close",t.close),this.joinedRoom.on("stream",t.stream),this.joinedRoom.on("data",t.data)}sendData(e){this.joinedRoom&&this.joinedRoom.send(e)}leaveRoom(){this.joinedRoom&&(this.joinedRoom.close(),this.joinedRoom=null)}},G={open:()=>{const e=S.joinedRoom.members;M.addMembers(e),S.sendData({type:"addImage",imageUrl:selfImgUrl,posX:D.x,posY:D.y}),B.textContent=P.value,P.value="",n.style.display="none",o.style.display="flex"},peerJoin:e=>{M.addMembers([e]),S.sendData({type:"addImage",imageUrl:selfImgUrl,posX:D.x,posY:D.y})},peerLeave:e=>{M.removeMembers([e]),d.removeAudioNodes([e]),A.clearRect(0,0,i,a),D.render(D.x,D.y),N.removeRemoteImg(e),delete E[e]},close:()=>{o.style.display="none",n.style.display="block",B.textContent="";const e=S.joinedRoom.members;M.removeMembers(e),d.removeAudioNodes(e),A.clearRect(0,0,i,a),D.render(D.x,D.y),N.removeRemoteImgAll(),E={}},stream:e=>{if(E[e.peerId]&&E[e.peerId].imageurl){const t=E[e.peerId].x??0,n=E[e.peerId].y??0,o=E[e.peerId].imageurl;N.addRemoteImg(e.peerId,o,t,n),d.addAudioNode(e,e.peerId),d.adjustPanning(D.x,D.y,t,n,e.peerId),delete E[e.peerId].x,delete E[e.peerId].y,delete E[e.peerId].imageUrl,E[e.peerId].observed=!0}else E[e.peerId]&&E[e.peerId].observed||(E[e.peerId]={},E[e.peerId].stream=e)},data:({src:e,data:t})=>{if("addImage"==t.type)if(M.assignImgSrc(e,t.imageUrl),E[e]&&E[e].stream){const n=E[e].stream;N.addRemoteImg(e,t.imageUrl,t.posX,t.posY),d.addAudioNode(n,e),d.adjustPanning(D.x,D.y,t.posX,t.posY,e),delete E[e].stream,delete E[e].x,delete E[e].y,E[e].observed=!0}else E[e]&&E[e].observed||(E[e]={},E[e].x=t.posX,E[e].y=t.posY,E[e].imageurl=t.imageUrl);"drawEvent"==t.type&&(E[e]&&E[e].observed?(A.clearRect(0,0,i,a),N.redrawRemoteImg(e,t.posX,t.posY),D.render(D.x,D.y),d.adjustPanning(D.x,D.y,t.posX,t.posY,e)):E[e]&&(E[e].x=t.posX,E[e].y=t.posY))}};document.getElementById("connect-btn").addEventListener("click",(async function(){if(!m){const e=await navigator.mediaDevices.getUserMedia({audio:!0});m=new t(e,r,c)}await S.makePeer(selfPeerId,credential,apiKey);const e=P.value;S.joinRoom(e,G,m.getFilteredStream())})),document.getElementById("disconnect-btn").addEventListener("click",(function(){S.leaveRoom()})),j.addEventListener("mousemove",(function(e){const t=j.getBoundingClientRect().left,n=j.getBoundingClientRect().top,o=e.clientX-t,s=e.clientY-n;if(D.dragging){A.clearRect(0,0,i,a),N&&N.redrawRemoteImgsAll();let e=D.relX+o,t=D.relY+s;e=Math.min(Math.max(e,0),1e3),t=Math.min(Math.max(t,0),650),D.render(e,t)}})),j.addEventListener("mousedown",(function(e){const t=j.getBoundingClientRect().left,n=j.getBoundingClientRect().top,o=e.clientX-t,i=e.clientY-n;D.isHoldPos(o,i)&&(D.dragging=!0,D.relX=D.x-o,D.relY=D.y-i)})),j.addEventListener("mouseup",(function(e){D.dragging=!1})),setInterval((function(){S.joinedRoom&&D&&S.sendData({type:"drawEvent",posX:D.x,posY:D.y})}),300)})();